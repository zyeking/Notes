



<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
        <link rel="canonical" href="https://zyeking.github.io/Notes/Golang/Project/go-gin-example/10 GORM-Callback/">
      
      
        <meta name="author" content="kingCheung">
      
      
        <meta name="lang:clipboard.copy" content="复制">
      
        <meta name="lang:clipboard.copied" content="已复制">
      
        <meta name="lang:search.language" content="ja">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="没有找到符合条件的结果">
      
        <meta name="lang:search.result.one" content="找到 1 个符合条件的结果">
      
        <meta name="lang:search.result.other" content="# 个符合条件的结果">
      
        <meta name="lang:search.tokenizer" content="[\uff0c\u3002]+">
      
      <link rel="shortcut icon" href="../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.6.0">
    
    
      
        <title>go-gin-example 10： GORM-Callback - kingCheung</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/application.1b62728e.css">
      
        <link rel="stylesheet" href="../../../../assets/stylesheets/application-palette.a8b3c06d.css">
      
      
        
        
        <meta name="theme-color" content="#009688">
      
    
    
      <script src="../../../../assets/javascripts/modernizr.268332fc.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../../../assets/fonts/material-icons.css">
    
    
    
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="teal" data-md-color-accent="pink">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#go-gin-example-10-gorm-callback" tabindex="1" class="md-skip">
        跳转至
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://zyeking.github.io/Notes/" title="kingCheung" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              kingCheung
            </span>
            <span class="md-header-nav__topic">
              
                go-gin-example 10： GORM-Callback
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            键入以开始搜索
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
        

  

<nav class="md-tabs md-tabs--active" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  <li class="md-tabs__item">
    
      <a href="../../../.." class="md-tabs__link">
        index
      </a>
    
  </li>

      
        
  
  
    
    
  
  
    <li class="md-tabs__item">
      
        <a href="../../../Basic/01 Channel/" class="md-tabs__link">
          Golang
        </a>
      
    </li>
  

  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../../../Python/01 UsingTesseract/" class="md-tabs__link">
          Python
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../../../Linux/01 FormattingUdisk/" class="md-tabs__link">
          Linux
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../../../Docker/01 ChangeImageSource/" class="md-tabs__link">
          Docker
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../../../Nginx/01 openstry/" class="md-tabs__link">
          Nginx
        </a>
      
    </li>
  

      
        
  
  
    
    
  
  
    <li class="md-tabs__item">
      
        <a href="../../../../Others/Excel/01 AutoCreateTime/" class="md-tabs__link">
          Others
        </a>
      
    </li>
  

  

      
    </ul>
  </div>
</nav>
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="https://zyeking.github.io/Notes/" title="kingCheung" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    kingCheung
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../../../.." title="index" class="md-nav__link">
      index
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2" checked>
    
    <label class="md-nav__link" for="nav-2">
      Golang
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Golang
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-1" type="checkbox" id="nav-2-1">
    
    <label class="md-nav__link" for="nav-2-1">
      Basic
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-1">
        Basic
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../Basic/01 Channel/" title="channel" class="md-nav__link">
      channel
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../Basic/02 UseDelveDebug/" title="使用delve调试Golang" class="md-nav__link">
      使用delve调试Golang
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../Basic/03 ArrayAndSlice.md" title="None" class="md-nav__link">
      None
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-2" type="checkbox" id="nav-2-2" checked>
    
    <label class="md-nav__link" for="nav-2-2">
      Project
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-2">
        Project
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-2-1" type="checkbox" id="nav-2-2-1" checked>
    
    <label class="md-nav__link" for="nav-2-2-1">
      go-gin-example
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-2-2-1">
        go-gin-example
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../01 Config/" title="go-gin-example 01：配置" class="md-nav__link">
      go-gin-example 01：配置
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../02 API-1/" title="go-gin-example 02：API-1" class="md-nav__link">
      go-gin-example 02：API-1
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../03 API-2/" title="go-gin-example 03：API-2" class="md-nav__link">
      go-gin-example 03：API-2
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../04 API-3/" title="go-gin-example 04：API-3" class="md-nav__link">
      go-gin-example 04：API-3
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../05 JWT/" title="go-gin-example 05：JWT" class="md-nav__link">
      go-gin-example 05：JWT
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../08 Swagger/" title="go-gin-example 08： Swagger" class="md-nav__link">
      go-gin-example 08： Swagger
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../09 Docker/" title="go-gin-example 09：Docker" class="md-nav__link">
      go-gin-example 09：Docker
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
    <a href="./" title="go-gin-example 10： GORM-Callback" class="md-nav__link md-nav__link--active">
      go-gin-example 10： GORM-Callback
    </a>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../FlowChart/" title="流程图" class="md-nav__link">
      流程图
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../InterfaceTestInstance/" title="接口测试实例" class="md-nav__link">
      接口测试实例
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-3" type="checkbox" id="nav-2-3">
    
    <label class="md-nav__link" for="nav-2-3">
      Go-Web
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-3">
        Go-Web
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../Go-Web/01 HTTPServe/" title="01：建立HTTP服务器的多种方法" class="md-nav__link">
      01：建立HTTP服务器的多种方法
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../Go-Web/02 BasicTemplateUsage/" title="02：基础模板" class="md-nav__link">
      02：基础模板
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../Go-Web/03 AdvanceTemplateUsage/" title="03：进阶模板用法" class="md-nav__link">
      03：进阶模板用法
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-4" type="checkbox" id="nav-2-4">
    
    <label class="md-nav__link" for="nav-2-4">
      ErrorCollect
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-4">
        ErrorCollect
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../ErrorCollect/20191127：Cannot fint main module[gomod]/" title="20191127：Cannot fint the main module[gomod]" class="md-nav__link">
      20191127：Cannot fint the main module[gomod]
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Python
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Python
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../Python/01 UsingTesseract/" title="Tesseract" class="md-nav__link">
      Tesseract
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../Python/02 dzdianpingSpider/" title="大众点评评价爬取逻辑" class="md-nav__link">
      大众点评评价爬取逻辑
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Linux
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Linux
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../Linux/01 FormattingUdisk/" title="01: 彻底格式化U盘" class="md-nav__link">
      01: 彻底格式化U盘
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../Linux/02 ChangeSources/" title="02: 更改Ubuntu源" class="md-nav__link">
      02: 更改Ubuntu源
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../Linux/03 Linux安装Golang/" title="03：Linux安装Golang" class="md-nav__link">
      03：Linux安装Golang
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../Linux/0n Hello Manjaro/" title="Hello Manjaro" class="md-nav__link">
      Hello Manjaro
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      Docker
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        Docker
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../Docker/01 ChangeImageSource/" title="Docker 01：修改镜像源" class="md-nav__link">
      Docker 01：修改镜像源
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../Docker/02 EntryPointAndCMD/" title="Docker 02：Dockerfile中的ENTRYPOINT、RUN与CMD" class="md-nav__link">
      Docker 02：Dockerfile中的ENTRYPOINT、RUN与CMD
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../Docker/03 Docker-Compose/" title="Docker-Compose快速入门" class="md-nav__link">
      Docker-Compose快速入门
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../Docker/04 使用Docker搭建Go开发环境/" title="使用Docker搭建Go开发环境" class="md-nav__link">
      使用Docker搭建Go开发环境
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../Docker/05 Docker-Compose2/" title="Docker-Compose 2" class="md-nav__link">
      Docker-Compose 2
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../Docker/06 使用Docker打包Go文件/" title="使用Docker打包Go文件" class="md-nav__link">
      使用Docker打包Go文件
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      Nginx
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        Nginx
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../Nginx/01 openstry/" title="01 openstry" class="md-nav__link">
      01 openstry
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../Nginx/02 将Go应用部署在Nginx上/" title="02 将Go应用部署在Nginx上" class="md-nav__link">
      02 将Go应用部署在Nginx上
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7">
    
    <label class="md-nav__link" for="nav-7">
      Others
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        Others
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7-1" type="checkbox" id="nav-7-1">
    
    <label class="md-nav__link" for="nav-7-1">
      Excel
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-7-1">
        Excel
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../Others/Excel/01 AutoCreateTime/" title="1. 自动创建数据时间，不受其他修改影响的`NOW()`" class="md-nav__link">
      	1. 自动创建数据时间，不受其他修改影响的`NOW()`
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../Others/Excel/02 AutoCreateTimeByMacro/" title="2. 用宏自动创建数据时间" class="md-nav__link">
      2. 用宏自动创建数据时间
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../Others/Excel/03 FormatUnit/" title="3. 为单元格添加格式" class="md-nav__link">
      3. 为单元格添加格式
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../Others/Excel/04 RepairArrowKey/" title="4. 方向键无法控制excel表格上下、左右移动" class="md-nav__link">
      4. 方向键无法控制excel表格上下、左右移动
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../Others/Excel/05 MultipleInsertValue/" title="5. 将单元格的空值换成目标值" class="md-nav__link">
      5. 将单元格的空值换成目标值
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../Others/01 MySql/" title="使用Mysql" class="md-nav__link">
      使用Mysql
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="go-gin-example-10-gorm-callback">go-gin-example 10： GORM-Callback</h1>
<h1 id="gorm-callbacks">定制GORM Callbacks</h1>
<h2 id="gorm-callback">GORM Callback 是什么</h2>
<blockquote>
<p>You could define callback methods to pointer of model struct, it will be called when creating, updating, querying, deleting, if any callback returns an error, gorm will stop future operations and rollback all changes.</p>
</blockquote>
<p>可以给模型结构体指针定义回调函数, 它将会在被创建/更新/查询/删除的时候调用, 如果回调返回了错误, gorm会停止未来行为操作并且回退所有改变. </p>
<hr />
<p>之前程序未实现<code>Callback</code>方法, 需要为所有文件单独写一次<code>BeforeCreate</code>、<code>BeforeUpdate</code>方法
<img alt="" src="http://q1hfuy9re.bkt.clouddn.com/20191206003247.png" />
<img alt="" src="http://q1hfuy9re.bkt.clouddn.com/20191206003400.png" /></p>
<h2 id="_1">使用</h2>
<h3 id="gormcallback">gorm支持的callback方法</h3>
<ul>
<li>创建：BeforeSave、BeforeCreate、AfterCreate、AfterSave</li>
<li>更新：BeforeSave、BeforeUpdate、AfterUpdate、AfterSave</li>
<li>删除：BeforeDelete、AfterDelete</li>
<li>查询：AfterFind</li>
</ul>
<h3 id="callback">定义callback</h3>
<ol>
<li>在<code>model.go</code>文件中定义
<div class="codehilite"><pre><span></span><span class="c1">// updateTimeStampForCreateCallback will set `CreatedOn`, `ModifiedOn` when creating</span>
<span class="kd">func</span> <span class="nx">updateTimeStampForCreateCallback</span><span class="p">(</span><span class="nx">scope</span> <span class="o">*</span><span class="nx">gorm</span><span class="p">.</span><span class="nx">Scope</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">!</span><span class="nx">scope</span><span class="p">.</span><span class="nx">HasError</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">nowTime</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">().</span><span class="nx">Unix</span><span class="p">()</span>
        <span class="k">if</span> <span class="nx">createTimeField</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">FieldByName</span><span class="p">(</span><span class="s">&quot;CreatedOn&quot;</span><span class="p">);</span> <span class="nx">ok</span> <span class="p">{</span>
            <span class="k">if</span> <span class="nx">createTimeField</span><span class="p">.</span><span class="nx">IsBlank</span> <span class="p">{</span>
                <span class="nx">createTimeField</span><span class="p">.</span><span class="nx">Set</span><span class="p">(</span><span class="nx">nowTime</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="nx">modifyTimeField</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">FieldByName</span><span class="p">(</span><span class="s">&quot;ModifiedOn&quot;</span><span class="p">);</span> <span class="nx">ok</span> <span class="p">{</span>
            <span class="k">if</span> <span class="nx">modifyTimeField</span><span class="p">.</span><span class="nx">IsBlank</span> <span class="p">{</span>
                <span class="nx">modifyTimeField</span><span class="p">.</span><span class="nx">Set</span><span class="p">(</span><span class="nx">nowTime</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// updateTimeStampForUpdateCallback will set `ModifyTime` when updating</span>
<span class="kd">func</span> <span class="nx">updateTimeStampForUpdateCallback</span><span class="p">(</span><span class="nx">scope</span> <span class="o">*</span><span class="nx">gorm</span><span class="p">.</span><span class="nx">Scope</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">Get</span><span class="p">(</span><span class="s">&quot;gorm:update_column&quot;</span><span class="p">);</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
        <span class="nx">scope</span><span class="p">.</span><span class="nx">SetColumn</span><span class="p">(</span><span class="s">&quot;ModifiedOn&quot;</span><span class="p">,</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">().</span><span class="nx">Unix</span><span class="p">())</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div></li>
<li>通过<code>scope.FieldByName(name)</code>判断是否存在相关字段, 该方法通过<code>scope.Fields()</code>获取所有字段</li>
<li>通过<code>.IsBlank</code>判断值是否为空</li>
<li>通过<code>.Set(interface{})</code>设置相关值</li>
<li>通过<code>scope.Get()</code>获取参数的参数值, 案例中回去查找<code>gorm:update_column</code>这个字段的属性</li>
<li>通过<code>scope.SetColumn(Field, value)</code>设定字段的值</li>
</ol>
<h3 id="callback_1">调用callback</h3>
<ol>
<li>在<code>model.go</code>的<code>ini</code>函数中注册callback
<div class="codehilite"><pre><span></span><span class="nx">db</span><span class="p">.</span><span class="nx">Callback</span><span class="p">().</span><span class="nx">Create</span><span class="p">().</span><span class="nx">Replace</span><span class="p">(</span><span class="s">&quot;gorm:update_time_stamp&quot;</span><span class="p">,</span> <span class="nx">updateTimeStampForCreateCallback</span><span class="p">)</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">Callback</span><span class="p">().</span><span class="nx">Update</span><span class="p">().</span><span class="nx">Replace</span><span class="p">(</span><span class="s">&quot;gorm:update_time_stamp&quot;</span><span class="p">,</span> <span class="nx">updateTimeStampForUpdateCallback</span><span class="p">)</span>
</pre></div></li>
</ol>
<h2 id="_2">效果</h2>
<p>当程序写了<code>Callback</code>方法的时候, 当GORM执行到相关的操作会自动触发相应的<code>Callback</code>方法</p>
<h2 id="_3">拓展</h2>
<ol>
<li>软删除, 添加删除时间, 为<code>model.go</code>的<code>Model</code>结构体添加<code>DeletedOn</code>字段
<div class="codehilite"><pre><span></span><span class="kd">type</span> <span class="nx">Model</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">ID</span> <span class="kt">int</span> <span class="s">`gorm:&quot;primary_key&quot; json:&quot;id&quot;`</span>
    <span class="nx">CreatedOn</span> <span class="kt">int</span> <span class="s">`json:&quot;created_on&quot;`</span>
    <span class="nx">ModifiedOn</span> <span class="kt">int</span> <span class="s">`json:&quot;modified_on&quot;`</span>
    <span class="nx">DeletedOn</span> <span class="kt">int</span> <span class="s">`json:&quot;deleted_on&quot;`</span>
<span class="p">}</span>
</pre></div></li>
</ol>
<p><div class="codehilite"><pre><span></span><span class="kd">func</span> <span class="nx">deleteCallback</span><span class="p">(</span><span class="nx">scope</span> <span class="o">*</span><span class="nx">gorm</span><span class="p">.</span><span class="nx">Scope</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">!</span><span class="nx">scope</span><span class="p">.</span><span class="nx">HasError</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">extraOption</span> <span class="kt">string</span>
        <span class="k">if</span> <span class="nx">str</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">Get</span><span class="p">(</span><span class="s">&quot;gorm:delete_option&quot;</span><span class="p">);</span> <span class="nx">ok</span> <span class="p">{</span>
            <span class="nx">extraOption</span> <span class="p">=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprint</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="nx">deletedOnField</span><span class="p">,</span> <span class="nx">hasDeletedOnField</span> <span class="o">:=</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">FieldByName</span><span class="p">(</span><span class="s">&quot;DeletedOn&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">!</span><span class="nx">scope</span><span class="p">.</span><span class="nx">Search</span><span class="p">.</span><span class="nx">Unscoped</span> <span class="o">&amp;&amp;</span> <span class="nx">hasDeletedOnField</span> <span class="p">{</span>
            <span class="nx">scope</span><span class="p">.</span><span class="nx">Raw</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span>
                <span class="s">&quot;UPDATE %v SET %v=%v%v%v&quot;</span><span class="p">,</span>
                <span class="nx">scope</span><span class="p">.</span><span class="nx">QuotedTableName</span><span class="p">(),</span>
                <span class="nx">scope</span><span class="p">.</span><span class="nx">Quote</span><span class="p">(</span><span class="nx">deletedOnField</span><span class="p">.</span><span class="nx">DBName</span><span class="p">),</span>
                <span class="nx">scope</span><span class="p">.</span><span class="nx">AddToVars</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">().</span><span class="nx">Unix</span><span class="p">()),</span>
                <span class="nx">addExtraSpaceIfExist</span><span class="p">(</span><span class="nx">scope</span><span class="p">.</span><span class="nx">CombinedConditionSql</span><span class="p">()),</span>
                <span class="nx">addExtraSpaceIfExist</span><span class="p">(</span><span class="nx">extraOption</span><span class="p">),</span>
            <span class="p">)).</span><span class="nx">Exec</span><span class="p">()</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">scope</span><span class="p">.</span><span class="nx">Raw</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span>
                <span class="s">&quot;DELETE FROM %v%v%v&quot;</span><span class="p">,</span>
                <span class="nx">scope</span><span class="p">.</span><span class="nx">QuotedTableName</span><span class="p">(),</span>
                <span class="nx">addExtraSpaceIfExist</span><span class="p">(</span><span class="nx">scope</span><span class="p">.</span><span class="nx">CombinedConditionSql</span><span class="p">()),</span>
                <span class="nx">addExtraSpaceIfExist</span><span class="p">(</span><span class="nx">extraOption</span><span class="p">),</span>
            <span class="p">)).</span><span class="nx">Exec</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">addExtraSpaceIfExist</span><span class="p">(</span><span class="nx">str</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">string</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nx">str</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="nx">str</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="s">&quot;&quot;</span>
<span class="p">}</span>
</pre></div>
在<code>model.go</code>的<code>ini函数</code>中添加<code>db.Callback().Delete().Replace("gorm:delete", deleteCallback)</code>
1. <code>scope.QuotedTableName()</code>返回引用的表名
2. <code>scope.Raw()</code>构建原生sql
3. <code>fmt.Sprintf()</code>格式化并且返回格式化后的字符串数据
4. <code>scope.AddToVars(value)</code>为字段添加参数
5. <code>scope.Quote()</code>转义
6. <code>scope</code>当你在数据库中文完成任何操作, scope包含了当前操作信息
<div class="codehilite"><pre><span></span><span class="c1">// Scope contain current operation&#39;s information when you perform any operation on the database</span>
<span class="kd">type</span> <span class="nx">Scope</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">Search</span>          <span class="o">*</span><span class="nx">search</span>
    <span class="nx">Value</span>           <span class="kd">interface</span><span class="p">{}</span>
    <span class="nx">SQL</span>             <span class="kt">string</span>
    <span class="nx">SQLVars</span>         <span class="p">[]</span><span class="kd">interface</span><span class="p">{}</span>
    <span class="nx">db</span>              <span class="o">*</span><span class="nx">DB</span>
    <span class="nx">instanceID</span>      <span class="kt">string</span>
    <span class="nx">primaryKeyField</span> <span class="o">*</span><span class="nx">Field</span>
    <span class="nx">skipLeft</span>        <span class="kt">bool</span>
    <span class="nx">fields</span>          <span class="o">*</span><span class="p">[]</span><span class="o">*</span><span class="nx">Field</span>
    <span class="nx">selectAttrs</span>     <span class="o">*</span><span class="p">[]</span><span class="kt">string</span>
<span class="p">}</span>
</pre></div></p>
<h2 id="ref">REF:</h2>
<p><a href="http://gorm.book.jasperxu.com/callbacks.html">official: callback in gorm</a></p>
                
                  
                
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../09 Docker/" title="go-gin-example 09：Docker" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  上一页
                </span>
                go-gin-example 09：Docker
              </span>
            </div>
          </a>
        
        
          <a href="../FlowChart/" title="流程图" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  下一页
                </span>
                流程图
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../../../assets/javascripts/application.808e90bb.js"></script>
      
        
        
          
          <script src="../../../../assets/javascripts/lunr/lunr.stemmer.support.js"></script>
          
            
              
                <script src="../../../../assets/javascripts/lunr/tinyseg.js"></script>
              
              
                <script src="../../../../assets/javascripts/lunr/lunr.ja.js"></script>
              
            
          
          
        
      
      <script>app.initialize({version:"1.0.4",url:{base:"../../../.."}})</script>
      
    
  </body>
</html>