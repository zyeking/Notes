# go-gin-example 03：API-2

- 完成博客的标签类接口定义和编写

## 定义接口

> 定义文章标签的路由分发操作

+ 获取标签列表：GET(“/tags”)
+ 新建标签：POST(“/tags”)
+ 更新指定标签：PUT(“/tags/:id”)
+ 删除指定标签：DELETE(“/tags/:id”)

## 空壳路由

> 注册路由将请求分发到该路由中，由该API路由中函数处理

+ `在./routers/api`下新建`v1`目录，目录内新建`tag.go`文件代表第一个API大版本

```go
package v1

import (
    "github.com/gin-gonic/gin"
)

// GetTags 获取多个文章标签
func GetTags(c *gin.Context) {
}

// AddTag 新增文章标签
func AddTag(c *gin.Context) {
}

// EditTag 修改文章标签
func EditTag(c *gin.Context) {
}

// DeleteTag 删除文章标签
func DeleteTag(c *gin.Context) {
}
```

## 注册路由

> 该路由负责分发各个api请求给相应的`handler`者

+ 打开`./routers`下的`router.go`文件，修改为：

```go
package routers

import (
	setting "go-gin-example/pkg/settings"
	v1 "go-gin-example/routers/api/v1"

	"github.com/gin-gonic/gin"
)

// InitRouter 初始化路由
func InitRouter() *gin.Engine {
	r := gin.New()

	r.Use(gin.Logger())
	r.Use(gin.Recovery())

	gin.SetMode(setting.RunMode)

	apiv1 := r.Group("/api/v1")
	{
		apiv1.GET("/tags", v1.GetTags)
		apiv1.POST("/tags", v1.AddTag)
		apiv1.PUT("/tags/:id", v1.EditTag)
		apiv1.DELETE("/tags/:id", v1.DeleteTag)
	}
	return r
}
```

+ 用`go run main.go`检测是否成功注册路由![](https://i.loli.net/2019/10/16/5aYko71PWEAfUxG.jpg)



## 表单验证

> 用beego的validation来进行表单校验数据
>
> 该`tag.go`模型中继承了`model.Model`结构体外新增了标签结构体中的一些属性，在该文件下除了通过`gorm`映射数据库模型外还添加了对标签的CRUD操作方法，在`./routers/api/v1/tag.go`中可以调用这些CRUD方法

+ `go get -u github.com/astaxie/beego/validation`
+ 在`models`目录下的`tag.go`写入

```go
package models

import (
	"time"

	"github.com/jinzhu/gorm"
)

// Tag 标签结构体
// 给结构体赋予json属性, 在c.JSON中会自动转换
type Tag struct {
    // 继承Model的结构体
	Model

	Name       string `json:"name"`
	CreatedBy  string `json:"created_by"`
	ModifiedBy string `json:"modified_by"`
	State      int    `json:"state"`
}

// BeforeCreate 创建标签之前自动补全CreatedOn时间
func (tag *Tag) BeforeCreate(scope *gorm.Scope) error {
	scope.SetColumn("CreatedOn", time.Now().Unix())
	return nil
}

// BeforeUpdate 更新标签之前自动补全ModifiedOn时间
func (tag *Tag) BeforeUpdate(scope *gorm.Scope) error {
	scope.SetColumn("ModifiedOn", time.Now().Unix())
	return nil
}

// GetTags 获取文章标签
func GetTags(pageNum int, pageSize int, maps interface{}) (tags []Tag) {
	db.Where(maps).Offset(pageNum).Limit(pageSize).Find(&tags)
	return
}

// GetTagTotal 获取全部文章标签
func GetTagTotal(maps interface{}) (count int) {
	db.Model(&Tag{}).Where(maps).Count(&count)
	return
}

// ExistTagByName 查询文章标签是否存在
func ExistTagByName(name string) bool {
	var tag Tag
	db.Select("id").Where("name = ?", name).First(&tag)
	if tag.ID > 0 {
		return true
	}
	return false
}

// ExistTagByID 查询ID文章是否存在
func ExistTagByID(id int) bool {
	var tag Tag
	db.Select("id").Where("id = ?", id).First(&tag)
	if tag.ID > 0 {
		return true
	}
	return false
}

// AddTag 添加文章标签
func AddTag(name string, state int, createdBy string) bool {
	db.Create(&Tag{
		Name:      name,
		State:     state,
		CreatedBy: createdBy,
	})
	return true
}

// DeleteTag 删除文章标签
func DeleteTag(id int) bool {
	db.Where("id = ? ", id).Delete(&Tag{})
	return true
}

// EditTag 编辑文章标签
func EditTag(id int, data interface{}) bool {
	db.Model(&Tag{}).Where("id = ? ", id).Update(data)
	return true
}
```

## 编写标签列表的路由逻辑

> 完善空壳路由
>
> 1. 通过`beego/validation`对URL传递进来的参数进行校验，操作为声明`validation.Validation`对象，调用其`.Required`、`.MaxSize`、`.Range`、`.Message`等方法
>
> 2. 通过`c.Query`获取URL中`?name=test&state=1`中的参数，`c.DefaultQuery`则支持设置一个默认值
> 3. `util.GetPage`确保各个接口的`page`处理是一致的

+ 在`./routers/v1/tag.go`写入

```go
package v1

import (
	"go-gin-example/models"
	"go-gin-example/pkg/e"
	setting "go-gin-example/pkg/settings"
	"go-gin-example/pkg/util"
	"net/http"

	"github.com/astaxie/beego/validation"
	"github.com/gin-gonic/gin"
	"github.com/unknwon/com"
)

// GetTags 获取文章标签
func GetTags(c *gin.Context) {
	// 从URL获取参数
	// localhost:8000/tags?name=test&state=1
	name := c.Query("name")
	
	maps := make(map[string]interface{})
	data := make(map[string]interface{})

	if name != "" {
		// 如果存在name参数, 将其添加到maps中
		maps["name"] = name
	}

	var state = -1 // should omit type , it will be inferred
	if arg := c.Query("state"); arg != "" {
		// 如果URL中存在state参数, 且arg不等于空的时候
		// 将state转换为int
		// 添加到maps["state"]中
		state = com.StrTo(arg).MustInt()
		maps["state"] = state
	}

	code := e.SUCCESS
    
	// 找到该文章,将其添加到lists中返回
	data["lists"] = models.GetTags(util.GetPage(c), setting.PageSize, maps)
	data["total"] = models.GetTagTotal(maps)

	c.JSON(http.StatusOK, gin.H{
		"code": code,
		"msg":  e.GetMsg(code),
		"data": data,
	})
}

// AddTag 增加文章标签
func AddTag(c *gin.Context) {
	name := c.Query("name")
	// state=0代表该标签不存在
    // 设置默认值为0
	state := com.StrTo(c.DefaultQuery("state", "0")).MustInt()
	createdBy := c.Query("created_by")

	valid := validation.Validation{}
	valid.Required(name, "name").Message("名称不能为空")
	valid.MaxSize(name, 100, "name").Message("名称最长为100字符")
	valid.Required(createdBy, "created_by").Message("创建人不能为空")
	valid.MaxSize(createdBy, 100, "created_by").Message("创建人最长为100字符")
	valid.Range(state, 0, 1, "starte").Message("状态只允许0或1")

	code := e.INVALID_PARAMS
	if !valid.HasErrors() {
		if !models.ExistTagByName(name) {
			code = e.SUCCESS
			models.AddTag(name, state, createdBy)
		} else {
			code = e.ERROR_EXIST_TAG
		}
	}

	c.JSON(http.StatusOK, gin.H{
		"code": code,
		"msg":  e.GetMsg(code),
		"data": make(map[string]string),
	})
}

// EditTag 修改文章标签
func EditTag(c *gin.Context) {
	id := com.StrTo(c.Param("id")).MustInt()
	name := c.Query("name")
	modifiedBy := c.Query("modified_by")

	valid := validation.Validation{}

	var state = -1
	if arg := c.Query("state"); arg != "" {
		state = com.StrTo(arg).MustInt()
		valid.Range(state, 0, 1, "state").Message("状态只允许0或1")
	}

	valid.Required(id, "id").Message("ID不能为空")
	valid.Required(modifiedBy, "modiified_by").Message("修改人不能为空")
	valid.MaxSize(modifiedBy, 100, "modified_by").Message("修改人最长为100字符")
	valid.MaxSize(name, 100, "name").Message("名称最长为100字符")

	code := e.INVALID_PARAMS
	if !valid.HasErrors() {
		code = e.SUCCESS
		if models.ExistTagByID(id) {
			data := make(map[string]interface{})
			data["modified_by"] = modifiedBy
			if name != "" {
				data["name"] = name
			}
			if state != -1 {
				data["state"] = state
			}
			models.EditTag(id, data)
		} else {
			// 不存在, 无法修改标签
			code = e.ERROR_NOT_EXIST_ARTICLE
		}
	}
	c.JSON(http.StatusOK, gin.H{
		"code":    code,
		"message": e.GetMsg(code),
		"data":    make(map[string]string),
	})
}

// DeleteTag 删除文章标签
func DeleteTag(c *gin.Context) {
	id := com.StrTo(c.Param("id")).MustInt()

	valid := validation.Validation{}
	valid.Min(id, 1, "id").Message("ID必须大于0")
	code := e.INVALID_PARAMS
	if !valid.HasErrors() {
		code = e.SUCCESS
		// 数据库操作
		if models.ExistTagByID(id) {
			models.DeleteTag(id)
		} else {
			code = e.ERROR_NOT_EXIST_TAG
		}
	}

	c.JSON(http.StatusOK, gin.H{
		"code": code,
		"msg":  e.GetMsg(code),
		"data": make(map[string]string),
	})
}
```

